! LOCAL GATEWAY CONFIGURATION TEMPLATE
!-------------------------------------
! HUSSAIN SHOAIB ALI
! TECHNICAL MARKETING ENGINEER
! https://cisco.box.com/WebexCalling
! ASK-CUBE@EXTERNAL.CISCO.COM
! UPDATED : September 9 2022! Tweaked by vyechuri for use in the Bootcamp
!-------------------------------------

!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
! This template is for building a LGW (on a vCUBE) deployment with CUCM where the CUCM !
! has its own dedicated PSTN GW ------------------------------------------------------!!
! Verify LGW interfaces for dial-peer bind statements based on your network ----------!!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
! v_ words needs to replaced with the correct parameters from the Control Hub      !
! Refer to the lab guide or complete Local Gateway Slide deck                   !
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

!!!!!!!!!!!!!!!!!!!!!!!!! IOS-XE 16.12.4 !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

!%%%%%%% BEGIN

configure terminal

key config-key password-encrypt dCloud123!
password encryption aes
!
crypto pki trustpoint dummyTp
revocation-check crl
exit
sip-ua
crypto signaling default trustpoint dummyTp cn-san-validate server
transport tcp tls v1.2
tcp-retry 1000
end


configure terminal
crypto pki trustpool import clean url http://www.cisco.com/security/pki/trs/ios_core.p7b
end
show crypto pki trustpool | include DigiCert


configure terminal
voice service voip 
  ip address trusted list
  !! Verify updated trust list from the Webex Calling Config Guide!!
  ipv4 23.89.76.128 255.255.255.128
  
  ipv4 170.72.29.0 255.255.255.0
  
  ipv4 170.72.17.128 255.255.255.128
  
  ipv4 170.72.0.128 255.255.255.128  
  
  ipv4 85.119.56.128 255.255.255.192
  ipv4 85.119.57.128 255.255.255.192
  ipv4 185.115.196.0 255.255.255.128
  ipv4 185.115.197.0 255.255.255.128
  ipv4 128.177.14.0 255.255.255.128
  ipv4 128.177.36.0 255.255.255.192
  ipv4 135.84.169.0 255.255.255.128
  ipv4 135.84.170.0 255.255.255.128
  ipv4 135.84.171.0 255.255.255.128
  ipv4 135.84.172.0 255.255.255.192
  ipv4 199.59.64.0 255.255.255.128
  ipv4 199.59.65.0 255.255.255.128
  ipv4 199.59.66.0 255.255.255.128
  ipv4 199.59.67.0 255.255.255.128
  ipv4 199.59.70.0 255.255.255.128
  ipv4 199.59.71.0 255.255.255.128
  ipv4 135.84.172.0 255.255.255.128
  ipv4 135.84.173.0 255.255.255.128
  ipv4 135.84.174.0 255.255.255.128
  ipv4 199.19.197.0 255.255.255.0
  ipv4 199.19.199.0 255.255.255.0
  ipv4 139.177.64.0 255.255.255.0
  ipv4 139.177.65.0 255.255.255.0
  ipv4 139.177.66.0 255.255.255.0
  ipv4 139.177.67.0 255.255.255.0
  ipv4 139.177.68.0 255.255.255.0
  ipv4 139.177.69.0 255.255.255.0
  ipv4 139.177.70.0 255.255.255.0
  ipv4 139.177.71.0 255.255.255.0
  ipv4 139.177.72.0 255.255.255.0
  ipv4 139.177.73.0 255.255.255.0
  
  ipv4 23.89.76.128 255.255.255.128
  
  ipv4 170.72.29.0 255.255.255.0
  
  ipv4 170.72.17.128 255.255.255.128
  
  ipv4 170.72.0.128 255.255.255.128
    exit
   allow-connections sip to sip
  media statistics 
  media bulk-stats
  no supplementary-service sip refer
  no supplementary-service sip handle-replaces
  fax protocol t38 version 0 ls-redundancy 0 hs-redundancy 0 fallback none
  stun
    stun flowdata agent-id 1 boot-count 4
    stun flowdata shared-secret 0 Password123$
  sip
    g729 annexb-all
    early-offer forced
    end


!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
! v_ words needs to replaced with the correct parameters from the Control Hub      !
! Refer to the lab guide or complete Local Gateway Slide deck                   !
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

configure terminal
voice class sip-profiles 200
  rule 9 request ANY sip-header SIP-Req-URI modify "sips:(.*)" "sip:\1"
  rule 10 request ANY sip-header To modify "<sips:(.*)" "<sip:\1"
  rule 11 request ANY sip-header From modify "<sips:" "<sip:\1"
  rule 12 request ANY sip-header Contact modify "<sips:(.*)>" "<sip:\1;transport=tls>"
  rule 13 response ANY sip-header To modify "<sips:(.*)" "<sip:\1"
  rule 14 response ANY sip-header From modify "<sips:(.*)" "<sip:\1"
  rule 15 response ANY sip-header Contact modify "<sips:(.*)" "<sip:\1"
  rule 20 request ANY sip-header From modify ">" ";otg=v_trunk_otg>"
  rule 30 request ANY sip-header P-Asserted-Identity modify "sips:(.*)" "sip:\1"


voice class codec 99
  codec preference 1 g711ulaw
  codec preference 2 g711alaw
  exit

voice class srtp-crypto 200
  crypto 1 AES_CM_128_HMAC_SHA1_80
  exit

voice class stun-usage 200
  stun usage firewall-traversal flowdata
  exit


!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
! v_ words needs to replaced with the correct parameters from the Control Hub      !
! Refer to the lab guide or complete Local Gateway Slide deck                   !
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

voice class tenant 200
  registrar dns:v_regdns scheme sips expires 240 refresh-ratio 50 tcp tls
  credentials number v_cred username v_uname password 0 v_passwd realm BroadWorks
  authentication username v_uname password 0 v_passwd realm BroadWorks
  authentication username v_uname password 0 v_passwd realm v_regdns
  no remote-party-id
  sip-server dns:v_regdns
  connection-reuse
  srtp-crypto 200
  session transport tcp tls
  url sips
  error-passthru
  asserted-id pai
  bind control source-interface GigabitEthernet1
  bind media source-interface GigabitEthernet1
  no pass-thru content custom-sdp
  sip-profiles 200
  outbound-proxy dns:v_proxy
  privacy-policy passthru


voice class tenant 100 
  session transport udp
  url sip
  error-passthru
  bind control source-interface GigabitEthernet2
  bind media source-interface GigabitEthernet2
  no pass-thru content custom-sdp

voice class tenant 300 
  bind control source-interface GigabitEthernet2
  bind media source-interface GigabitEthernet2
  no pass-thru content custom-sdp



!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
!! REPLACE A.B.C.D with ITSP's IP Address %
!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% 
voice class uri 100 sip
 host ipv4:198.18.133.3


voice class uri 200 sip
 pattern :8934

!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
!! Assumes CUCM signaling via port for Webex Calling SIP trunk is set to 5065 %
!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
voice class uri 300 sip
 pattern :5065


voice class server-group 301
 ipv4 198.18.133.33 port 5065


!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
!! REPLACE C.U.C.M with CUCM's IP Address %
!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
voice class uri 302 sip
 pattern 198.18.133.33:5060


!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
!! REPLACE C.U.C.M with CUCM's IP Address %
!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% 
voice class server-group 305
 ipv4 198.18.133.33


dial-peer voice 101 voip
 description Outgoing dial-peer to IP PSTN
 destination-pattern BAD.BAD
 session protocol sipv2
 !%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
 !! REPLACE A.B.C.D with ITSP's IP Address %
 !%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% 
 session target ipv4:198.18.133.3
 voice-class codec 99  
 voice-class sip tenant 100
 dtmf-relay rtp-nte
 no vad

dial-peer voice 200201 voip
 description Inbound/Outbound Webex Calling
 destination-pattern BAD.BAD
 session protocol sipv2
 session target sip-server
 voice-class codec 99
 dtmf-relay rtp-nte
 voice-class stun-usage 200
 no voice-class sip localhost
 voice-class sip tenant 200
 srtp
 no vad

dial-peer voice 301 voip
 description Outgoing dial-peer to Unified CM Webex Calling Trunk for inbound from Webex
 destination-pattern BAD.BAD
 session protocol sipv2
 session server-group 301
 voice-class codec 99
 dtmf-relay rtp-nte
 voice-class sip tenant 100
 no vad

dial-peer voice 305 voip
 description Outgoing dial-peer to Unified CM PSTN SIP trunk
 destination-pattern BAD.BAD
 session protocol sipv2
 session server-group 305
 voice-class codec 99 
 dtmf-relay rtp-nte
 voice-class sip tenant 100
 no vad

voice class dpg 100
 description Incoming CUCM (DP302) to PSTN(DP101)
 dial-peer 101 preference 1

voice class dpg 200
 description Incoming CUCM (DP300) to WxC(DP200201)
 dial-peer 200201 preference 1

voice class dpg 300
 description Incoming WxC (DP200201) to CUCM(DP301)
 dial-peer 301 preference 1

voice class dpg 302
 description Incoming PSTN (DP100) to CUCM(DP305)
 dial-peer 305 preference 1

dial-peer voice 100 voip
 description Incoming dial-peer from PSTN
 session protocol sipv2
 destination dpg 302
 incoming uri via 100
 voice-class codec 99
 dtmf-relay rtp-nte
 voice-class sip tenant 300
 no vad

dial-peer voice 200201 voip
 description Inbound/Outbound Webex Calling
 max-conn 150
 destination dpg 300
 incoming uri via 200

dial-peer voice 300 voip
 description Incoming dial-peer from Unified CM for Webex
 session protocol sipv2
 destination dpg 200
 incoming uri via 300
 voice-class codec 99
 dtmf-relay rtp-nte
 voice-class sip tenant 300
 no vad

dial-peer voice 302 voip
 description Incoming dial-peer from CUCM for PSTN
 session protocol sipv2
 destination dpg 100
 incoming uri via 302
 voice-class codec 99
 dtmf-relay rtp-nte
 voice-class sip tenant 300
 no vad


end

!!%%%%% END-TEMPLATE
